<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Taro Agric Farm — Dashboard + Production Data</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#6b7280; --accent:#22d3ee; --accent-2:#a78bfa; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b; --card-good:rgba(34,197,94,0.12); --card-warn:rgba(245,158,11,0.12); --card-bad:rgba(239,68,68,0.12); }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 80% -10%, rgba(34,211,238,0.12), transparent), radial-gradient(900px 500px at -10% 20%, rgba(167,139,250,0.12), transparent), var(--bg); color:#e5e7eb; font-family:Inter,system-ui,Arial;}
    .container{max-width:1200px;margin:0 auto;padding:0 20px;}
    .dash-header{position:sticky;top:0;z-index:10;background:rgba(17,24,39,.7);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06)}
    .dash-header .container{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand i{color:var(--accent)}
    .dash-nav a{color:#cbd5e1;text-decoration:none;margin-left:18px;padding:6px 10px;border-radius:6px;cursor:pointer}
    .tabs{display:flex;gap:8px;justify-content:center;margin:12px 0}
    .tabs button{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#cbd5e1;padding:8px 12px;border-radius:8px;cursor:pointer}
    .tabs button.active{background:linear-gradient(180deg, rgba(34,211,238,.06), transparent 60%);color:#fff}
    .dash-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
    .kpi-card{background:linear-gradient(180deg, rgba(34,211,238,.06), transparent 60%),var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25);text-align:left;transition:box-shadow .25s,border-color .25s}
    .kpi-card.status-good{box-shadow:0 10px 40px var(--card-good);border-color:var(--card-good)}
    .kpi-card.status-warn{box-shadow:0 10px 40px var(--card-warn);border-color:var(--card-warn)}
    .kpi-card.status-bad{box-shadow:0 10px 40px var(--card-bad);border-color:var(--card-bad)}
    .kpi-title{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
    .kpi-value{font-size:26px;font-weight:800;margin-top:6px}
    .kpi-trend{margin-top:8px;font-size:12px;color:#94a3b8}
    .panel{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.3)}
    .panel-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .panel-header i{color:var(--accent-2)}
    .span-2{grid-column:span 2}
    .device-list{list-style:none;padding:0;margin:0}
    .device-list li{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.06)}
    .prod-kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
    .prod-kpi{background:linear-gradient(180deg, rgba(34,211,238,.03), transparent),var(--panel);border-radius:12px;padding:14px;text-align:center}
    .prod-kpi .label{font-size:12px;color:#94a3b8;text-transform:uppercase}
    .prod-kpi .val{font-weight:800;font-size:20px;margin-top:6px}
    table{width:100%;border-collapse:collapse;color:#cbd5e1}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.04);text-align:left}
    thead th{color:#94a3b8}
    @media(max-width:1024px){.dash-grid{grid-template-columns:repeat(2,1fr)}.span-2{grid-column:span 2}.prod-kpi-row{grid-template-columns:repeat(2,1fr)}}@media(max-width:600px){.dash-grid{grid-template-columns:1fr}.prod-kpi-row{grid-template-columns:1fr}}
    
    .traffic-light { display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:8px; vertical-align:middle; box-shadow:0 0 6px rgba(0,0,0,0.4); border:2px solid rgba(0,0,0,0.25); }
    .traffic-green{ background:#22c55e; box-shadow:0 0 8px #22c55e33; }
    .traffic-yellow{ background:#f59e0b; box-shadow:0 0 8px #f59e0b33; }
    .traffic-red{ background:#ef4444; box-shadow:0 0 8px #ef444433; }
    .logs{overflow-y:auto;font-size:13px;font-family:monospace;max-height:320px;padding:8px 0}
    .logs .row{padding:6px 12px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;gap:8px;transition:background 0.2s}
    .logs .row:hover{background:rgba(255,255,255,0.03)}
    .logs .row.warn{background:rgba(245,158,11,0.1);border-left:3px solid var(--warn)}
    .logs .row.bad{background:rgba(239,68,68,0.1);border-left:3px solid var(--bad)}
    .logs .ts{color:#94a3b8;font-weight:600;min-width:80px}
    .logs .msg{color:#cbd5e1;flex:1}
    .panel-actions{display:flex;gap:8px;align-items:center}
    .btn-sm{background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);color:#22d3ee;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;transition:all 0.2s}
    .btn-sm:hover{background:rgba(34,211,238,0.2);border-color:rgba(34,211,238,0.5)}
    
    /* Custom Modal Styles */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:1000;display:none;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s}
    .modal-overlay.show{display:flex;opacity:1}
    .modal{background:var(--panel);border:1px solid rgba(255,255,255,0.1);border-radius:14px;padding:24px;min-width:400px;max-width:90vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.5);transform:scale(0.9);transition:transform 0.2s}
    .modal-overlay.show .modal{transform:scale(1)}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.1)}
    .modal-title{font-size:18px;font-weight:700;color:#fff;margin:0}
    .modal-close{background:transparent;border:none;color:#94a3b8;font-size:24px;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:6px;transition:all 0.2s}
    .modal-close:hover{background:rgba(255,255,255,0.1);color:#fff}
    .modal-body{margin-bottom:20px;color:#cbd5e1}
    .modal-input{width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px 12px;color:#fff;font-size:14px;margin-top:8px;box-sizing:border-box}
    .modal-input:focus{outline:none;border-color:var(--accent);background:rgba(255,255,255,0.08)}
    .modal-label{display:block;margin-bottom:4px;color:#94a3b8;font-size:13px;text-transform:uppercase;letter-spacing:0.05em}
    .modal-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.1)}
    .modal-btn{background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);color:#22d3ee;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s}
    .modal-btn:hover{background:rgba(34,211,238,0.2);border-color:rgba(34,211,238,0.5)}
    .modal-btn.primary{background:linear-gradient(135deg, rgba(34,211,238,0.2), rgba(167,139,250,0.2));border-color:var(--accent);color:#fff}
    .modal-btn.primary:hover{background:linear-gradient(135deg, rgba(34,211,238,0.3), rgba(167,139,250,0.3))}
    .modal-btn.danger{background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.3);color:#ef4444}
    .modal-btn.danger:hover{background:rgba(239,68,68,0.2);border-color:rgba(239,68,68,0.5)}
    
    /* Login/Auth Styles */
    .auth-status{display:flex;align-items:center;gap:10px}
    .auth-user{color:#cbd5e1;font-size:13px}
    .auth-btn{background:rgba(34,211,238,0.1);border:1px solid rgba(34,211,238,0.3);color:#22d3ee;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;transition:all 0.2s}
    .auth-btn:hover{background:rgba(34,211,238,0.2);border-color:rgba(34,211,238,0.5)}
    .login-form{display:flex;flex-direction:column;gap:16px}
    .login-form .modal-input{margin-top:4px}
    .auth-error{color:#ef4444;font-size:12px;margin-top:4px}
    .otp-note{margin-top:8px;font-size:12px;color:#94a3b8;line-height:1.5}
    .protected-message{text-align:center;padding:40px 20px;color:#94a3b8}
    .protected-message i{font-size:48px;color:var(--accent);margin-bottom:16px;display:block}
    </style>
</head>
<body>
<header class="dash-header"><div class="container"><div class="brand"><i class="fas fa-signal"></i><span>Taro Agric Farm/AAKTP Dashboard</span></div><nav class="dash-nav"><a id="nav-home" class="active">Home</a><a id="nav-production">Production Data</a><div class="auth-status" id="auth-status"><span class="auth-user" id="auth-user"></span><button class="auth-btn" id="auth-btn">Login</button></div><a id="toggle-theme">Theme</a></nav></div></header>
<div class="tabs container"><button id="tab-home" class="active">Home</button><button id="tab-production">Production Data</button></div>
<main class="dash-main"><div class="container">
<section id="home" class="page">
  <div class="dash-grid" id="home-grid">
    <div class="kpi-card" id="card-temp"><div class="kpi-title"><span class="traffic-light" id="tl-temp"></span>Temperature</div><div class="kpi-value" id="kpi-temp">-- °C</div><div class="kpi-trend" id="kpi-temp-trend">Loading...</div></div>
    <div class="kpi-card" id="card-hum"><div class="kpi-title"><span class="traffic-light" id="tl-hum"></span>Humidity</div><div class="kpi-value" id="kpi-hum">-- %</div><div class="kpi-trend" id="kpi-hum-trend">Loading...</div></div>
    <div class="kpi-card" id="card-aqi"><div class="kpi-title"><span class="traffic-light" id="tl-aqi"></span>Air Quality</div><div class="kpi-value" id="kpi-aqi">-- AQI</div><div class="kpi-trend" id="kpi-aqi-trend">Loading...</div></div>
    <div class="kpi-card" id="thpi-card" style="display:flex;flex-direction:row;align-items:center;justify-content:space-between;gap:12px"><div style="flex:1"><div class="kpi-title"><span class="traffic-light" id="tl-thpi"></span>THPI</div><div class="kpi-value" id="kpi-thpi">--</div><div class="kpi-trend" id="kpi-thpi-trend">Overall index</div></div><div style="width:140px;height:120px;"><canvas id="thpiGauge" width="140" height="120"></canvas></div></div>
    <div class="kpi-card" id="thi-card" style="display:flex;flex-direction:row;align-items:center;justify-content:space-between;gap:12px">
      <div style="flex:1">
        <div class="kpi-title">THI <span class="traffic-light" id="tl-thi"></span></div>
        <div class="kpi-value" id="kpi-thi">--</div>
        <div class="kpi-trend" id="kpi-thi-trend">Overall index</div>
      </div>
      <div style="width:140px;height:120px;">
        <canvas id="thiGauge" width="140" height="120"></canvas>
      </div>
    </div>

</div>

    <div class="panel"><div class="panel-header"><i class="fas fa-thermometer-half"></i><span>Temperature Stream</span></div><canvas id="chart-temp" height="120"></canvas></div>
    <div class="panel"><div class="panel-header"><i class="fas fa-tint"></i><span>Humidity Stream</span></div><canvas id="chart-hum" height="120"></canvas></div>

    <div class="panel span-2"><div class="panel-header"><i class="fas fa-wind"></i><span><span class="traffic-light" id="tl-tvoc"></span>TVOC Sensor (NH3 / NO2 / H2S / CO)</span></div><div class="device-list"><li><span>NH3 (Ammonia)</span><span class="badge" id="voc-nh3">0.0 PPM</span></li><li><span>NO2 (Nitrogen Dioxide)</span><span class="badge" id="voc-no2">0.0 PPM</span></li><li><span>H2S (Hydrogen Sulfide)</span><span class="badge" id="voc-h2s">0.0 PPM</span></li><li><span>CO (Carbon Monoxide)</span><span class="badge" id="voc-co">0.0 PPM</span></li></div></div>

    <div class="panel span-2"><div class="panel-header"><i class="fas fa-smog"></i><span><span class="traffic-light" id="tl-pm"></span>Particulate Matter</span></div><div class="device-list"><li><span>PM 2.5</span><span class="badge" id="pm-25">0 µg/m³</span></li><li><span>PM 10</span><span class="badge" id="pm-10">0 µg/m³</span></li></div></div>

    <div class="panel"><div class="panel-header"><i class="fas fa-sun"></i><span><span class="traffic-light" id="tl-light"></span>Light Intensity</span></div><div class="device-list"><li><span>Illuminance</span><span class="badge" id="light-lux">0 lux</span></li></div></div>

    <div class="panel"><div class="panel-header"><i class="fas fa-volume-up"></i><span>Noise Levels</span></div><div class="device-list"><li><span>Sound Pressure</span><span class="badge" id="noise-db">0 dB</span></li><li><span>Peak</span><span class="badge" id="noise-peak">0 dB</span></li><li><span>Average</span><span class="badge" id="noise-avg">0 dB</span></li></div></div>

    <div class="panel span-2"><div class="panel-header"><i class="fas fa-microphone"></i><span>Microphone (Audio Recording)</span></div><div class="logs" id="mic-log"><div class="row"><span class="ts">[00:00:01]</span><span class="msg">Microphone activated</span></div></div></div>

    <div class="panel"><div class="panel-header"><i class="fas fa-map-marker-alt"></i><span>Device Status</span></div><ul class="device-list" id="device-list"><li><span>Sensor-01</span><span class="badge online">online</span></li></ul></div>

    <div class="panel span-2"><div class="panel-header"><i class="fas fa-list"></i><span>Event Logs</span><div class="panel-actions"><button class="btn-sm" id="clear-logs">Clear</button><button class="btn-sm" id="download-csv">Download CSV</button><button class="btn-sm" id="download-sensors-csv">Download Sensors CSV</button></div></div><div class="logs" id="logs" style="height:320px;"></div></div>

  </div>
</section>

<section id="production" class="page" style="display:none;margin-top:12px">
  <div id="production-content">
    <div class="prod-kpi-row"><div class="prod-kpi"><div class="label">Birds Alive</div><div class="val" id="kp-birds-alive">0</div></div><div class="prod-kpi"><div class="label">Birds Dead</div><div class="val" id="kp-birds-dead">0</div></div><div class="prod-kpi"><div class="label">FCR</div><div class="val" id="kp-fcr">—</div></div><div class="prod-kpi"><div class="label">Birds Sold</div><div class="val" id="kp-birds-sold">—</div></div></div>

    <div class="panel"><h3>Batch Summary</h3><table><tbody><tr><th>Concurrent batches</th><td id="v-concurrent">0</td></tr><tr><th>Batch no</th><td id="v-batchno">—</td></tr><tr><th>Population</th><td id="v-pop">0 birds</td></tr><tr><th>Died</th><td id="v-died">0 birds</td></tr><tr><th>Mortality rate</th><td id="v-mort">0%</td></tr><tr><th>Age</th><td id="v-age">— days</td></tr><tr><th>Average weight</th><td id="v-weight">0 g</td></tr><tr><th>Feed consumed (per bird)</th><td id="v-feed">0 g</td></tr><tr><th>FCR</th><td id="v-fcr">—</td></tr><tr><th>Sold</th><td id="v-sold"></td></tr></tbody></table></div>

    <div class="panel" style="margin-top:12px"><h3>Batch History</h3><div style="overflow:auto;max-height:320px"><table style="width:100%"><thead><tr><th>Batch</th><th>Population</th><th>Died</th><th>Mortality</th><th>Age</th><th>Avg wt (g)</th><th>Feed (g)</th><th>FCR</th><th>Sold</th><th>Actions</th></tr></thead><tbody id="historyBody"></tbody></table></div><div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end"><button id="btn-add" class="btn-sm">Add</button><button id="btn-clear" class="btn-sm">Clear</button><button id="btn-export" class="btn-sm">Export CSV</button></div></div>
  </div>
  <div id="production-protected" class="protected-message" style="display:none">
    <i class="fas fa-lock"></i>
    <h3>Authentication Required</h3>
    <p>Please login to access production data.</p>
    <button class="modal-btn primary" onclick="showLoginModal()" style="margin-top:16px">Login</button>
  </div>
</section>

</div></main>

<!-- Custom Modal -->
<div id="customModal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">Modal</h3>
      <button class="modal-close" id="modalClose">&times;</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer" id="modalFooter"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
function el(id){return document.getElementById(id);}
function setText(id,txt){const e=el(id); if(e) e.textContent=txt;}

// Custom Modal System
const modal = el('customModal');
const modalTitle = el('modalTitle');
const modalBody = el('modalBody');
const modalFooter = el('modalFooter');
const modalClose = el('modalClose');

function showModal(title, body, buttons) {
  modalTitle.textContent = title;
  modalBody.innerHTML = body;
  modalFooter.innerHTML = '';
  
  if (buttons && buttons.length > 0) {
    buttons.forEach(btn => {
      const button = document.createElement('button');
      button.className = 'modal-btn' + (btn.className ? ' ' + btn.className : '');
      button.textContent = btn.text;
      button.onclick = async () => {
        const shouldAutoClose = btn?.closeOnClick !== false;
        if (shouldAutoClose) {
          hideModal();
        }
        if (btn.onclick) {
          try {
            await btn.onclick();
          } catch (err) {
            console.error('Modal button handler error:', err);
          }
        }
      };
      modalFooter.appendChild(button);
    });
  } else {
    const okBtn = document.createElement('button');
    okBtn.className = 'modal-btn primary';
    okBtn.textContent = 'OK';
    okBtn.onclick = hideModal;
    modalFooter.appendChild(okBtn);
  }
  
  modal.classList.add('show');
}

function hideModal() {
  modal.classList.remove('show');
}

modalClose.onclick = hideModal;
modal.onclick = (e) => {
  if (e.target === modal) hideModal();
};

// Custom alert replacement
function customAlert(message) {
  return new Promise(resolve => {
    showModal('Alert', `<p>${message}</p>`, [{
      text: 'OK',
      className: 'primary',
      onclick: () => resolve(true)
    }]);
  });
}

// Custom confirm replacement
function customConfirm(message) {
  return new Promise(resolve => {
    showModal('Confirm', `<p>${message}</p>`, [
      {
        text: 'Cancel',
        onclick: () => resolve(false)
      },
      {
        text: 'OK',
        className: 'primary',
        onclick: () => resolve(true)
      }
    ]);
  });
}

// Custom prompt replacement
function customPrompt(message, defaultValue = '') {
  return new Promise(resolve => {
    const inputId = 'modal-input-' + Date.now();
    const body = `<label class="modal-label">${message}</label><input type="text" id="${inputId}" class="modal-input" value="${defaultValue}" autofocus>`;
    
    showModal('Input', body, [
      {
        text: 'Cancel',
        onclick: () => resolve(null)
      },
      {
        text: 'OK',
        className: 'primary',
        onclick: () => {
          const input = document.getElementById(inputId);
          resolve(input ? input.value : null);
        }
      }
    ]);
    
    // Focus input and handle Enter key
    setTimeout(() => {
      const input = document.getElementById(inputId);
      if (input) {
        input.focus();
        input.select();
        input.onkeydown = (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const okBtn = modalFooter.querySelector('.primary');
            if (okBtn) okBtn.click();
          } else if (e.key === 'Escape') {
            e.preventDefault();
            hideModal();
            resolve(null);
          }
        };
      }
    }, 100);
  });
}
// tabs
const tabHome = el('tab-home'), tabProd = el('tab-production'), pageHome = el('home'), pageProd = el('production');
function showHome(){tabHome.classList.add('active'); tabProd.classList.remove('active'); pageHome.style.display='block'; pageProd.style.display='none';}
async function showProd(){
  // Check authentication before showing production data
  const isAuthenticated = await checkAuth();
  
  if (!isAuthenticated) {
    showLoginModal();
    return;
  }
  
  tabProd.classList.add('active'); 
  tabHome.classList.remove('active'); 
  pageProd.style.display='block'; 
  pageHome.style.display='none';
  updateProductionAccess();
}
tabHome.addEventListener('click', showHome); 
tabProd.addEventListener('click', showProd);

// Navigation links
el('nav-home')?.addEventListener('click', showHome);
el('nav-production')?.addEventListener('click', async () => {
  await showProd();
});

showHome();

// Check auth on page load
setTimeout(async () => {
  await checkAuth();
}, 500);

// charts
const tempChart = new Chart(el('chart-temp'), { type:'line', data:{ labels:Array(20).fill(''), datasets:[{ data:Array(20).fill(0), borderColor:'#e74c3c', backgroundColor:'#e74c3c33', tension:0.4, pointRadius:0, borderWidth:3 }] }, options:{ animation:false, responsive:true, plugins:{ legend:{ display:false } }, scales:{ x:{ display:false } } } });
const humChart = new Chart(el('chart-hum'), { type:'line', data:{ labels:Array(20).fill(''), datasets:[{ data:Array(20).fill(0), borderColor:'#3498db', backgroundColor:'#3498db33', tension:0.4, pointRadius:0, borderWidth:3 }] }, options:{ animation:false, responsive:true, plugins:{ legend:{ display:false } }, scales:{ x:{ display:false } } } });

// THPI
const thpiCtx = el('thpiGauge').getContext('2d');
const thpiGauge = new Chart(thpiCtx, {
  type:'doughnut',
  data:{ labels:['Good','Moderate','Poor'], datasets:[{ data:[40,20,40], backgroundColor:['#22c55e','#f59e0b','#ef4444'], borderWidth:0 }]},
  options:{ circumference: Math.PI, rotation: Math.PI, cutout:'70%', responsive:false, plugins:{legend:{display:false}, tooltip:{enabled:false}} },
  plugins:[{
    id:'thpiPointer',
    afterDraw(chart){
      const value = chart.$value ?? 0;
      const ctx = chart.ctx; const cx = chart.getDatasetMeta(0).data[0].x; const cy = chart.getDatasetMeta(0).data[0].y; const r = chart.getDatasetMeta(0).data[0].outerRadius;
      const angle = Math.PI - (value/100)*Math.PI;
      ctx.save(); ctx.translate(cx,cy); ctx.rotate(angle); ctx.beginPath(); ctx.moveTo(0,-6); ctx.lineTo(r*0.6,0); ctx.lineTo(0,6); ctx.fillStyle='#111827'; ctx.fill();
      ctx.beginPath(); ctx.arc(r*0.62,0,4,0,2*Math.PI); ctx.fillStyle='#fff'; ctx.fill(); ctx.restore();
      ctx.fillStyle='#e5e7eb'; ctx.font='700 18px Inter, Arial'; ctx.textAlign='center'; ctx.fillText(String(Math.round(value)), cx, cy+20);
    }
  }]
});

    // --- THI (Temperature-Humidity Index) ---
    function computeTHIFromSensors(s){
      const T = Number(s.temp);
      const RH = Number(s.humidity);
      const thi = T - (0.55 - 0.0055 * RH) * (T - 14.5);
      return +thi.toFixed(1);
    }

    // create THI gauge (same style as THPI)
    (function(){
      const thiCanvas = document.getElementById('thiGauge');
      if(!thiCanvas) return;
      const thiCtx = thiCanvas.getContext('2d');
      window.thiGauge = new Chart(thiCtx, {
        type: 'doughnut',
        data: {
          labels:['Good','Moderate','Poor'],
          datasets:[{ data:[40,20,40], backgroundColor:['#22c55e','#f59e0b','#ef4444'], borderWidth:0, hoverOffset:0 }]
        },
        options: {
          circumference: Math.PI,
          rotation: Math.PI,
          cutout: '70%',
          responsive: false,
          plugins:{ legend:{ display:false }, tooltip:{ enabled:false } }
        },
        plugins: [{
          id: 'thiPointer',
          afterDraw: function(chart){
            const value = chart.$value ?? 0;
            const ctx = chart.ctx;
            const meta = chart.getDatasetMeta(0).data[0];
            const cx = meta.x, cy = meta.y, r = meta.outerRadius;
            const angle = Math.PI - (value/100)*Math.PI;
            ctx.save(); ctx.translate(cx,cy); ctx.rotate(angle);
            ctx.beginPath(); ctx.moveTo(0,-6); ctx.lineTo(r*0.6,0); ctx.lineTo(0,6); ctx.fillStyle='#111827'; ctx.fill();
            ctx.beginPath(); ctx.arc(r*0.62,0,4,0,2*Math.PI); ctx.fillStyle='#fff'; ctx.fill();
            ctx.restore();
            ctx.fillStyle = '#e5e7eb'; ctx.font='700 18px Inter, Arial'; ctx.textAlign='center'; ctx.fillText(String(Math.round(value)), cx, cy+20);
          }
        }]
      });
    })();

    function setTHI(v){
      if(window.thiGauge){ window.thiGauge.$value = Math.max(0, Math.min(100, v)); window.thiGauge.draw(); }
      setText('kpi-thi', Math.round(v));
      const status = getStatusFor('thi', v);
      setText('kpi-thi-trend', getTrendText('thi', v, status));
    }

    let lastThiCategory = null;
function setTHPI(v){ 
  thpiGauge.$value = Math.max(0,Math.min(100,v)); 
  thpiGauge.draw(); 
  setText('kpi-thpi', Math.round(v)); 
  const status = getStatusFor('thpi', v);
  setText('kpi-thpi-trend', getTrendText('thpi', v, status)); 
}

// ThingSpeak API Configuration
const THINGSPEAK_CHANNEL = 3143545;
const THINGSPEAK_API_URL = `https://api.thingspeak.com/channels/${THINGSPEAK_CHANNEL}/feeds.json`;

// sensor data structure
let sim = { temp:27.5, humidity:55, airQuality:80, voc_nh3:48, voc_no2:3, voc_h2s:0.5, voc_co:0.5, pm25:null, pm10:null, light:null, noise:null };

// Fetch data from ThingSpeak API
async function fetchThingSpeakData(results = 1) {
  try {
    const response = await fetch(`${THINGSPEAK_API_URL}?results=${results}`);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const data = await response.json();
    
    if (!data.feeds || data.feeds.length === 0) {
      console.warn('No feeds available from ThingSpeak');
      return null;
    }
    
    // Get the latest feed
    const latestFeed = data.feeds[data.feeds.length - 1];
    
    // Map ThingSpeak fields to dashboard structure
    // field1: Temperature, field2: Humidity, field3: eCO2, field4: TVOC
    // field5: H2S, field6: CO, field7: NH3, field8: NO2
    // Helper function to parse values (handle 0 correctly)
    const parseField = (value, fallback) => {
      const parsed = parseFloat(value);
      return (isNaN(parsed) || value === null || value === undefined) ? fallback : parsed;
    };
    
    return {
      temp: parseField(latestFeed.field1, sim.temp),
      humidity: parseField(latestFeed.field2, sim.humidity),
      airQuality: parseField(latestFeed.field3, sim.airQuality), // eCO2 as AQI approximation
      voc_nh3: parseField(latestFeed.field7, sim.voc_nh3),
      voc_no2: parseField(latestFeed.field8, sim.voc_no2),
      voc_h2s: parseField(latestFeed.field5, sim.voc_h2s),
      voc_co: parseField(latestFeed.field6, sim.voc_co),
      // Sensors not available from ThingSpeak - set to null
      pm25: null,
      pm10: null,
      light: null,
      noise: null,
      timestamp: latestFeed.created_at
    };
  } catch (error) {
    console.error('Error fetching ThingSpeak data:', error);
    if(typeof addLog === 'function') {
      addLog('API fetch error: ' + error.message, 'warn');
    }
    return null;
  }
}

function randomWalk(prev,min,max,step=1,jitter=0.2){ let next = prev + (Math.random()-0.5)*step + (Math.random()-0.5)*jitter; if(next<min) next=min+Math.random(); if(next>max) next=max-Math.random(); return +next.toFixed(2); }
function computeTHPI(s){ 
  const t=s.temp; 
  let tScore=0; 
  if(t<=20) tScore=60-(20-t)*2; 
  else if(t<=28) tScore=100; 
  else tScore=Math.max(0,100-(t-28)*6); 
  const h=s.humidity; 
  let hScore=0; 
  if(h>=40&&h<=70) hScore=100; 
  else if(h<40) hScore=Math.max(0,100-(40-h)*2); 
  else hScore=Math.max(0,100-(h-70)*2); 
  const a=s.airQuality; 
  let aScore=Math.max(0,Math.min(100,100-(a/200)*100)); 
  
  // Check if PM25 is available
  const hasPM25 = s.pm25 !== null && s.pm25 !== undefined;
  if(hasPM25) {
    // Original calculation with all factors
    const p25 = s.pm25; 
    const pScore=Math.max(0,Math.min(100,100-(p25/120)*100)); 
    return (tScore*0.25 + hScore*0.2 + aScore*0.35 + pScore*0.2);
  } else {
    // Without PM25 - redistribute weights proportionally: 0.25+0.2+0.35 = 0.8
    // New weights: temp=0.25/0.8=0.3125, hum=0.2/0.8=0.25, aqi=0.35/0.8=0.4375
    return (tScore*0.3125 + hScore*0.25 + aScore*0.4375);
  }
}

function getStatusFor(sensor,value){
  // THI (Temperature-Humidity Index) - for poultry/agriculture
  if(sensor==='thi'){ 
    if(value < 68) return 'good';      // Comfortable
    if(value < 75) return 'warn';      // Moderate stress
    return 'bad';                       // High stress
  }
  
  // THPI (Temperature-Humidity-PM-Air Quality Index)
  if(sensor==='thpi'){ 
    if(value >= 80) return 'good';     // Excellent conditions
    if(value >= 60) return 'warn';     // Moderate conditions
    return 'bad';                       // Poor conditions
  }

  // Temperature (°C) - optimal for agricultural/poultry environment
  if(sensor==='temp'){ 
    if(value >= 20 && value <= 30) return 'good';        // Optimal range
    if((value > 30 && value <= 35) || (value < 20 && value >= 15)) return 'warn';  // Acceptable
    return 'bad';                                        // Critical
  }
  
  // Humidity (%) - optimal for agricultural/poultry environment
  if(sensor==='humidity'){ 
    if(value >= 40 && value <= 75) return 'good';       // Optimal range
    if((value >= 30 && value < 40) || (value > 75 && value <= 85)) return 'warn';  // Acceptable
    return 'bad';                                        // Critical
  }
  
  // Air Quality Index (AQI) - based on eCO2
  if(sensor==='aqi'){ 
    if(value <= 50) return 'good';     // Good air quality
    if(value <= 100) return 'warn';    // Moderate
    return 'bad';                       // Unhealthy
  }
  
  // NH3 (Ammonia) in PPM - critical for poultry health
  if(sensor==='nh3'){ 
    if(value <= 25) return 'good';     // Safe level
    if(value <= 50) return 'warn';     // Moderate - action needed
    return 'bad';                       // Dangerous - immediate action
  }
  
  // NO2 (Nitrogen Dioxide) in PPM
  if(sensor==='no2'){ 
    if(value <= 0.5) return 'good';    // Safe level
    if(value <= 1.0) return 'warn';    // Moderate
    return 'bad';                       // High - concerning
  }
  
  // H2S (Hydrogen Sulfide) in PPM - toxic gas
  if(sensor==='h2s'){ 
    if(value <= 10) return 'good';     // Safe level
    if(value <= 30) return 'warn';     // Moderate - monitor closely
    return 'bad';                       // Dangerous - toxic levels
  }
  
  // CO (Carbon Monoxide) in PPM - deadly gas
  if(sensor==='co'){ 
    if(value <= 9) return 'good';      // Safe level (OSHA 8-hour limit: 50 PPM)
    if(value <= 35) return 'warn';     // Moderate - monitor closely (OSHA 8-hour limit)
    return 'bad';                       // Dangerous - toxic/deadly levels
  }
  
  // PM2.5 (Particulate Matter 2.5) in µg/m³
  if(sensor==='pm25'){ 
    if(value <= 35) return 'good';     // Good air quality
    if(value <= 55) return 'warn';     // Moderate
    return 'bad';                       // Unhealthy
  }
  
  // PM10 (Particulate Matter 10) in µg/m³
  if(sensor==='pm10'){ 
    if(value <= 50) return 'good';     // Good air quality
    if(value <= 100) return 'warn';    // Moderate
    return 'bad';                       // Unhealthy
  }
  
  // Light Intensity (lux)
  if(sensor==='light'){ 
    if(value >= 150 && value <= 1000) return 'good';    // Optimal for poultry
    if((value >= 50 && value < 150) || (value > 1000 && value <= 2000)) return 'warn';  // Acceptable
    return 'bad';                                       // Too dark or too bright
  }
  
  return 'good';
}

// Get descriptive trend text based on sensor status
function getTrendText(sensor, value, status) {
  if(sensor === 'temp') {
    if(status === 'good') return 'Optimal range';
    if(status === 'warn') {
      if(value > 30) return 'Slightly high';
      if(value < 20) return 'Slightly low';
      return 'Acceptable';
    }
    if(value > 35) return 'Too high - critical';
    return 'Too low - critical';
  }
  
  if(sensor === 'humidity') {
    if(status === 'good') return 'Optimal range';
    if(status === 'warn') {
      if(value > 75) return 'Slightly high';
      if(value < 40) return 'Slightly low';
      return 'Acceptable';
    }
    if(value > 85) return 'Too high - critical';
    return 'Too low - critical';
  }
  
  if(sensor === 'aqi') {
    if(status === 'good') return 'Good air quality';
    if(status === 'warn') return 'Moderate air quality';
    return 'Unhealthy - action needed';
  }
  
  if(sensor === 'thi') {
    if(status === 'good') return 'Comfortable';
    if(status === 'warn') return 'Moderate stress';
    return 'High stress - cooling needed';
  }
  
  if(sensor === 'thpi') {
    if(status === 'good') return 'Excellent conditions';
    if(status === 'warn') return 'Moderate conditions';
    return 'Poor conditions - check sensors';
  }
  
  return 'Monitoring';
}
function setCardClass(cardId,status){ const elc = document.getElementById(cardId); if(!elc) return; elc.classList.remove('status-good','status-warn','status-bad'); if(status==='good') elc.classList.add('status-good'); if(status==='warn') elc.classList.add('status-warn'); if(status==='bad') elc.classList.add('status-bad'); }

function applyCardStatus(){
  setCardClass('card-temp', getStatusFor('temp', sim.temp));
  setCardClass('card-hum', getStatusFor('humidity', sim.humidity));
  setCardClass('card-aqi', getStatusFor('aqi', sim.airQuality));
  // THPI card - use actual THPI value for status
  const thpiVal = computeTHPI(sim);
  setCardClass('thpi-card', getStatusFor('thpi', thpiVal));
  if(document.getElementById('card-light') && sim.light !== null && sim.light !== undefined) {
    setCardClass('card-light', getStatusFor('light', sim.light));
  }
}

function updateSensorsDisplay(s){
  setText('kpi-temp', s.temp.toFixed(1) + ' °C');
  setText('kpi-hum', s.humidity.toFixed(0) + ' %');
  setText('kpi-aqi', s.airQuality.toFixed(0) + ' AQI');
  setText('voc-nh3', s.voc_nh3.toFixed(1) + ' PPM');
  setText('voc-no2', s.voc_no2.toFixed(2) + ' PPM');
  setText('voc-h2s', s.voc_h2s.toFixed(2) + ' PPM');
  setText('voc-co', s.voc_co.toFixed(2) + ' PPM');
  // Display nil for sensors not available from ThingSpeak
  setText('pm-25', s.pm25 !== null && s.pm25 !== undefined ? Math.round(s.pm25) + ' µg/m³' : 'nil');
  setText('pm-10', s.pm10 !== null && s.pm10 !== undefined ? Math.round(s.pm10) + ' µg/m³' : 'nil');
  setText('light-lux', s.light !== null && s.light !== undefined ? Math.round(s.light) + ' lux' : 'nil');
  setText('noise-db', s.noise !== null && s.noise !== undefined ? Math.round(s.noise) + ' dB' : 'nil');
  
  // Update trend text based on sensor status
  const tempStatus = getStatusFor('temp', s.temp);
  const humStatus = getStatusFor('humidity', s.humidity);
  const aqiStatus = getStatusFor('aqi', s.airQuality);
  setText('kpi-temp-trend', getTrendText('temp', s.temp, tempStatus));
  setText('kpi-hum-trend', getTrendText('humidity', s.humidity, humStatus));
  setText('kpi-aqi-trend', getTrendText('aqi', s.airQuality, aqiStatus));
  
  tempChart.data.datasets[0].data.push(s.temp); tempChart.data.datasets[0].data.shift(); tempChart.update();
  humChart.data.datasets[0].data.push(s.humidity); humChart.data.datasets[0].data.shift(); humChart.update();
  const thpi = computeTHPI(s); setTHPI(thpi);
  applyCardStatus(); applyTrafficLights(s);

    function applyTrafficLights(s){
      function setTL(id, status){
        const el = document.getElementById(id);
        if(!el) return;
        el.classList.remove('traffic-green','traffic-yellow','traffic-red');
        if(status==='good') el.classList.add('traffic-green');
        else if(status==='warn') el.classList.add('traffic-yellow');
        else el.classList.add('traffic-red');
      }
      
      // Temperature traffic light
      setTL('tl-temp', getStatusFor('temp', s.temp));
      
      // Humidity traffic light
      setTL('tl-hum', getStatusFor('humidity', s.humidity));
      
      // Air Quality Index traffic light
      setTL('tl-aqi', getStatusFor('aqi', s.airQuality));
      
      // THPI traffic light - use actual THPI value
      const thpiVal = computeTHPI(s);
      setTL('tl-thpi', getStatusFor('thpi', thpiVal));
      
      // THI traffic light - compute from temp and humidity
      try{ 
        const thiVal = typeof computeTHIFromSensors==='function' ? computeTHIFromSensors(s) : null; 
        if(thiVal!==null) setTL('tl-thi', getStatusFor('thi', thiVal));
      }catch(e){}
      
      // TVOC traffic light - use worst status among NH3, NO2, H2S, CO
      const nh3Status = getStatusFor('nh3', s.voc_nh3);
      const no2Status = getStatusFor('no2', s.voc_no2);
      const h2sStatus = getStatusFor('h2s', s.voc_h2s);
      const coStatus = getStatusFor('co', s.voc_co);
      // Priority: bad > warn > good
      let worstStatus = 'good';
      if(nh3Status === 'bad' || no2Status === 'bad' || h2sStatus === 'bad' || coStatus === 'bad') worstStatus = 'bad';
      else if(nh3Status === 'warn' || no2Status === 'warn' || h2sStatus === 'warn' || coStatus === 'warn') worstStatus = 'warn';
      setTL('tl-tvoc', worstStatus);
      
      // PM2.5 traffic light - only if value is available
      if(s.pm25 !== null && s.pm25 !== undefined) {
        setTL('tl-pm', getStatusFor('pm25', s.pm25));
      } else {
        // Gray out or hide if nil
        const pmEl = document.getElementById('tl-pm');
        if(pmEl) {
          pmEl.classList.remove('traffic-green','traffic-yellow','traffic-red');
          pmEl.style.opacity = '0.3';
        }
      }
      
      // Light intensity traffic light - only if value is available
      if(s.light !== null && s.light !== undefined) {
        setTL('tl-light', getStatusFor('light', s.light));
      } else {
        // Gray out or hide if nil
        const lightEl = document.getElementById('tl-light');
        if(lightEl) {
          lightEl.classList.remove('traffic-green','traffic-yellow','traffic-red');
          lightEl.style.opacity = '0.3';
        }
      }
    }
  // Alert logging based on sensor status
  // PM2.5 alerts - only if available
  if(s.pm25 !== null && s.pm25 !== undefined && s.pm25 > 55) {
    addLog('PM 2.5 elevated: ' + Math.round(s.pm25) + ' µg/m³','warn');
  }
  
  // NH3 alerts - consistent with status thresholds
  const nh3Status = getStatusFor('nh3', s.voc_nh3);
  if(nh3Status === 'bad' && s.voc_nh3 > 50) {
    addLog('DANGER: High NH3 level: ' + s.voc_nh3.toFixed(1) + ' PPM - Immediate action needed!', 'warn');
  } else if(nh3Status === 'warn' && s.voc_nh3 > 25) {
    addLog('Warning: Elevated NH3: ' + s.voc_nh3.toFixed(1) + ' PPM - Monitor closely', 'warn');
  }
  
  // NO2 alerts
  const no2Status = getStatusFor('no2', s.voc_no2);
  if(no2Status === 'bad' && s.voc_no2 > 1.0) {
    addLog('DANGER: High NO2 level: ' + s.voc_no2.toFixed(2) + ' PPM - Immediate action needed!', 'warn');
  } else if(no2Status === 'warn' && s.voc_no2 > 0.5) {
    addLog('Warning: Elevated NO2: ' + s.voc_no2.toFixed(2) + ' PPM - Monitor closely', 'warn');
  }
  
  // H2S alerts
  const h2sStatus = getStatusFor('h2s', s.voc_h2s);
  if(h2sStatus === 'bad' && s.voc_h2s > 30) {
    addLog('DANGER: High H2S level: ' + s.voc_h2s.toFixed(2) + ' PPM - Toxic levels detected!', 'warn');
  } else if(h2sStatus === 'warn' && s.voc_h2s > 10) {
    addLog('Warning: Elevated H2S: ' + s.voc_h2s.toFixed(2) + ' PPM - Monitor closely', 'warn');
  }
  
  // CO alerts
  const coStatus = getStatusFor('co', s.voc_co);
  if(coStatus === 'bad' && s.voc_co > 35) {
    addLog('CRITICAL: High CO level: ' + s.voc_co.toFixed(2) + ' PPM - Deadly gas detected! Evacuate immediately!', 'warn');
  } else if(coStatus === 'warn' && s.voc_co > 9) {
    addLog('Warning: Elevated CO: ' + s.voc_co.toFixed(2) + ' PPM - Monitor closely', 'warn');
  }
  
  // Temperature alerts
  const tempStatusAlert = getStatusFor('temp', s.temp);
  if(tempStatusAlert === 'bad') {
    if(s.temp > 35) {
      addLog('CRITICAL: Temperature too high: ' + s.temp.toFixed(1) + '°C - Cooling required!', 'warn');
    } else if(s.temp < 15) {
      addLog('CRITICAL: Temperature too low: ' + s.temp.toFixed(1) + '°C - Heating required!', 'warn');
    }
  } else if(tempStatusAlert === 'warn' && s.temp > 30) {
    addLog('Warning: Temperature elevated: ' + s.temp.toFixed(1) + '°C - Monitor conditions', 'warn');
  }
  
  // Air Quality alerts
  const aqiStatusAlert = getStatusFor('aqi', s.airQuality);
  if(aqiStatusAlert === 'bad' && s.airQuality > 100) {
    addLog('CRITICAL: Unhealthy air quality: ' + s.airQuality.toFixed(0) + ' AQI - Ventilation needed!', 'warn');
  } else if(aqiStatusAlert === 'warn' && s.airQuality > 50) {
    addLog('Warning: Moderate air quality: ' + s.airQuality.toFixed(0) + ' AQI - Monitor conditions', 'warn');
  }
}

// Update sensor data - fetch from ThingSpeak API
async function updateSensorData() {
  const apiData = await fetchThingSpeakData(1);
  
  if (apiData) {
    // Update sim with real API data
    sim.temp = apiData.temp;
    sim.humidity = apiData.humidity;
    sim.airQuality = apiData.airQuality;
    sim.voc_nh3 = apiData.voc_nh3;
    sim.voc_no2 = apiData.voc_no2;
    sim.voc_h2s = apiData.voc_h2s;
    sim.voc_co = apiData.voc_co;
    // Set sensors not in ThingSpeak to null (nil)
    sim.pm25 = apiData.pm25;
    sim.pm10 = apiData.pm10;
    sim.light = apiData.light;
    sim.noise = apiData.noise;
    
    // Update display with real data
    updateSensorsDisplay(sim);
    const thi = computeTHIFromSensors(sim);
    setTHI(thi);
    
    // Log successful data fetch (only occasionally to avoid spam)
    if (!window.lastSuccessLog || (Date.now() - window.lastSuccessLog) > 30000) {
      addLog('Data updated from ThingSpeak API - ' + new Date().toLocaleTimeString(), '');
      window.lastSuccessLog = Date.now();
    }
  } else {
    // Fallback to simulation if API fails
    addLog('API connection failed - using fallback simulation data', 'warn');
    sim.temp = randomWalk(sim.temp, 20, 35, 0.5, 0.3);
    sim.humidity = randomWalk(sim.humidity, 30, 90, 1.2, 0.5);
    sim.airQuality = randomWalk(sim.airQuality, 30, 200, 2, 1);
    sim.voc_nh3 = randomWalk(sim.voc_nh3, 0, 400, 4, 1);
    sim.voc_no2 = randomWalk(sim.voc_no2, 0, 5, 0.1, 0.05);
    sim.voc_h2s = randomWalk(sim.voc_h2s, 0, 10, 0.2, 0.05);
    sim.voc_co = randomWalk(sim.voc_co, 0, 50, 0.5, 0.1);
    // Keep nil for sensors not in ThingSpeak even in fallback mode
    sim.pm25 = null;
    sim.pm10 = null;
    sim.light = null;
    sim.noise = null;
    updateSensorsDisplay(sim);
    const thi = computeTHIFromSensors(sim);
    setTHI(thi);
  }
}

// Initial log message
addLog('System initialized - EnviroTrack Dashboard started', '');
addLog('Connecting to ThingSpeak API (Channel: ' + THINGSPEAK_CHANNEL + ')...', '');

// Initial data fetch
updateSensorData();

// Update every 3 seconds (ThingSpeak free tier allows 15-second intervals, but we'll poll every 3s)
setInterval(updateSensorData, 3000);

// logs and producers
let lastLogMessages = {}; // Track last log messages to prevent duplicates
let logDebounceTime = 5000; // 5 seconds debounce for duplicate messages

function addLog(msg, type='') {
  const logs = document.getElementById('logs');
  if (!logs) return;
  
  const now = new Date();
  const ts = now.toLocaleTimeString();
  
  // Check for duplicate messages within debounce time (for alerts only)
  if (type === 'warn' || type === 'bad') {
    const msgKey = msg.substring(0, 50); // Use first 50 chars as key
    const lastTime = lastLogMessages[msgKey];
    if (lastTime && (now - lastTime) < logDebounceTime) {
      return; // Skip duplicate alert within debounce period
    }
    lastLogMessages[msgKey] = now;
  }
  
  const div = document.createElement('div');
  div.className = 'row' + (type ? ' ' + type : '');
  div.innerHTML = `<span class="ts">[${ts}]</span><span class="msg">${msg}</span>`;
  logs.prepend(div);
  
  // Keep only last 50 log entries
  while(logs.children.length > 50) {
    logs.removeChild(logs.lastChild);
  }
  
  // Auto-scroll to top (newest logs)
  logs.scrollTop = 0;
}

// Supabase Configuration
const SUPABASE_URL = 'https://lgqjjabzzdjwfqhwvmva.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxncWpqYWJ6emRqd2ZxaHd2bXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NTk5MzcsImV4cCI6MjA3ODAzNTkzN30.01JGXuqV1FqfHxObRI6OfMwVLWnaOqQFgTLWez3oKM8';

const OTP_ALLOWED_EMAILS = new Set([
  'soseni@oauife.edu.ng',
  'olamideakintaro@gmail.com',
  'hbashiru@oauife.edu.ng',
  'ajayiayobamiayodeji@gmail.com',
  'suninterlinktech@gmail.com'
].map(email => email.toLowerCase()));

let supabaseClient = null;

// Initialize Supabase client after page loads
function initSupabase() {
  try {
    if (typeof supabase !== 'undefined' && supabase.createClient) {
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase client initialized successfully');
      addLog('Supabase connected', '');
      setupAuthListener(); // Setup auth state listener
      return true;
    } else {
      console.warn('Supabase library not loaded');
      addLog('Supabase library not available - using local storage only', 'warn');
      return false;
    }
  } catch (e) {
    console.error('Supabase initialization error:', e);
    addLog('Supabase initialization failed: ' + e.message, 'warn');
    return false;
  }
}

// Try to initialize immediately, and also on window load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSupabase);
} else {
  // If already loaded, try immediately
  setTimeout(initSupabase, 100); // Small delay to ensure script is loaded
}

// Authentication State
let currentUser = null;

// Check authentication status
async function checkAuth() {
  if (!supabaseClient) return false;
  
  try {
    const { data: { user }, error } = await supabaseClient.auth.getUser();
    if (error) throw error;
    
    if (user) {
      currentUser = user;
      updateAuthUI(user);
      return true;
    } else {
      currentUser = null;
      updateAuthUI(null);
      return false;
    }
  } catch (err) {
    console.error('Auth check failed:', err);
    currentUser = null;
    updateAuthUI(null);
    return false;
  }
}

// Update authentication UI
function updateAuthUI(user) {
  const authUser = el('auth-user');
  const authBtn = el('auth-btn');
  
  if (user) {
    authUser.textContent = user.email || 'Logged in';
    authBtn.textContent = 'Logout';
    authBtn.onclick = handleLogout;
  } else {
    authUser.textContent = '';
    authBtn.textContent = 'Login';
    authBtn.onclick = showLoginModal;
  }
  
  // Update production section visibility
  updateProductionAccess();
}

// Show login modal
function showLoginModal() {
  const emailId = 'login-email-' + Date.now();
  const errorId = 'login-error-' + Date.now();
  
  const body = `
    <div class="login-form">
      <div>
        <label class="modal-label">Email</label>
        <input type="email" id="${emailId}" class="modal-input" placeholder="name@example.com" autofocus>
      </div>
      <div id="${errorId}" class="auth-error" style="display:none"></div>
      <p class="otp-note">Enter your authorized email address to receive a one-time login code.</p>
    </div>
  `;
  
  showModal('Secure Login', body, [
    {
      text: 'Cancel',
      onclick: () => {}
    },
    {
      text: 'Send OTP',
      className: 'primary',
      closeOnClick: false,
      onclick: async () => {
        const email = document.getElementById(emailId).value;
        const errorDiv = document.getElementById(errorId);
        await handleOtpRequest(email, errorDiv);
      }
    }
  ]);
  
  // Handle Enter key
  setTimeout(() => {
    const emailInput = document.getElementById(emailId);
    if (emailInput) {
      emailInput.onkeydown = async (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const errorDiv = document.getElementById(errorId);
          await handleOtpRequest(emailInput.value, errorDiv);
        }
      };
    }
  }, 100);
}

function isOtpEmailAllowed(email) {
  if (!email) return false;
  return OTP_ALLOWED_EMAILS.has(email.trim().toLowerCase());
}

async function handleOtpRequest(email, errorDiv) {
  const cleanEmail = (email || '').trim();

  if (!cleanEmail) {
    errorDiv.textContent = 'Please enter the email address where the OTP should be sent';
    errorDiv.style.display = 'block';
    return;
  }

  if (!isOtpEmailAllowed(cleanEmail)) {
    errorDiv.textContent = 'This email is not authorized for login. Please contact the administrator.';
    errorDiv.style.display = 'block';
    return;
  }

  if (!supabaseClient) {
    errorDiv.textContent = 'Supabase not initialized';
    errorDiv.style.display = 'block';
    return;
  }

  try {
    errorDiv.style.display = 'none';
    const { error } = await supabaseClient.auth.signInWithOtp({
      email: cleanEmail,
      options: {
        shouldCreateUser: false,
        emailRedirectTo: window.location.origin + window.location.pathname,
        emailOtpType: 'code'
      }
    });

    if (error) throw error;

    addLog('OTP email sent: ' + cleanEmail, '');
    hideModal();
    showOtpVerificationModal(cleanEmail);
  } catch (err) {
    console.error('OTP request error:', err);
    errorDiv.textContent = err.message || 'Unable to send OTP at the moment. Please try again shortly.';
    errorDiv.style.display = 'block';
  }
}

function showOtpVerificationModal(email) {
  const codeId = 'otp-code-' + Date.now();
  const errorId = 'otp-error-' + Date.now();

  const body = `
    <div class="login-form">
      <p class="otp-note">Enter the login code sent to <strong>${email}</strong>.</p>
      <input type="text" id="${codeId}" class="modal-input" placeholder="12345678" inputmode="numeric" pattern="[0-9]*" maxlength="10">
      <div id="${errorId}" class="auth-error" style="display:none"></div>
    </div>
  `;

  showModal('Verify OTP', body, [
    {
      text: 'Cancel',
      onclick: () => {}
    },
    {
      text: 'Verify',
      className: 'primary',
      closeOnClick: false,
      onclick: async () => {
        const code = document.getElementById(codeId)?.value;
        const errorDiv = document.getElementById(errorId);
        await handleOtpVerify(email, code, errorDiv);
      }
    }
  ]);

  setTimeout(() => {
    const input = document.getElementById(codeId);
    if (input) input.focus();
  }, 100);
}

async function handleOtpVerify(email, code, errorDiv) {
  if (!supabaseClient) {
    errorDiv.textContent = 'Supabase not initialized';
    errorDiv.style.display = 'block';
    return;
  }

  if (!isOtpEmailAllowed(email)) {
    errorDiv.textContent = 'This email is not authorized for login. Please contact the administrator.';
    errorDiv.style.display = 'block';
    return;
  }

  const cleanCode = (code || '').trim();

  if (!cleanCode) {
    errorDiv.textContent = 'Please enter the login code from your email.';
    errorDiv.style.display = 'block';
    return;
  }

  if (!/^\d{6,10}$/.test(cleanCode)) {
    errorDiv.textContent = 'Login code should be 6 to 10 digits.';
    errorDiv.style.display = 'block';
    return;
  }

  try {
    errorDiv.style.display = 'none';
    const { data, error } = await supabaseClient.auth.verifyOtp({
      email: email.trim(),
      token: cleanCode,
      type: 'email'
    });

    if (error) throw error;

    if (data?.user) {
      currentUser = data.user;
      updateAuthUI(data.user);
      hideModal();
      addLog('User logged in via OTP: ' + email, '');
      await checkAuth();
    } else {
      errorDiv.textContent = 'Unable to verify the OTP. Please double-check the code or use the magic link.';
      errorDiv.style.display = 'block';
    }
  } catch (err) {
    console.error('OTP verification error:', err);
    errorDiv.textContent = err.message || 'OTP verification failed. Please try again.';
    errorDiv.style.display = 'block';
  }
}

// Handle logout
async function handleLogout() {
  if (!supabaseClient) return;
  
  try {
    const { error } = await supabaseClient.auth.signOut();
    if (error) throw error;
    
    currentUser = null;
    updateAuthUI(null);
    addLog('User logged out', '');
    
    // If on production page, redirect to home
    if (pageProd.style.display !== 'none') {
      showHome();
    }
  } catch (err) {
    console.error('Logout error:', err);
    await customAlert('Logout failed: ' + err.message);
  }
}

// Update production section access
function updateProductionAccess() {
  const productionContent = el('production-content');
  const productionProtected = el('production-protected');
  
  if (currentUser) {
    // User is authenticated - show content
    if (productionContent) productionContent.style.display = 'block';
    if (productionProtected) productionProtected.style.display = 'none';
  } else {
    // User not authenticated - show protected message
    if (productionContent) productionContent.style.display = 'none';
    if (productionProtected) productionProtected.style.display = 'block';
  }
}

// Setup auth state listener after Supabase is initialized
function setupAuthListener() {
  if (supabaseClient) {
    supabaseClient.auth.onAuthStateChange((event, session) => {
      console.log('Auth state changed:', event, session);
      if (event === 'SIGNED_IN' && session) {
        currentUser = session.user;
        updateAuthUI(session.user);
      } else if (event === 'SIGNED_OUT') {
        currentUser = null;
        updateAuthUI(null);
      }
    });
  }
}

// Make showLoginModal globally available
window.showLoginModal = showLoginModal;

const PKEY='taro_prod_records_v2';
const PROD_TABLE = 'production_records'; // Supabase table name

// Load records from localStorage (fallback) or Supabase
async function loadRecords(options = {}){ 
  const { promptForLogin = true } = options;

  // Check authentication first
  if (!currentUser) {
    if (promptForLogin) {
      showLoginModal();
    }
    return [];
  }
  
  // Try Supabase first
  if (supabaseClient) {
    try {
      const { data, error } = await supabaseClient
        .from(PROD_TABLE)
        .select('*')
        .order('created_at', { ascending: true });
      
      if (error) throw error;
      if (data && data.length > 0) {
        // Sync to localStorage as backup
        localStorage.setItem(PKEY, JSON.stringify(data));
        return data;
      }
    } catch (err) {
      console.warn('Supabase fetch failed, using localStorage:', err);
      addLog('Production data: Using local storage (Supabase unavailable)', 'warn');
    }
  }
  
  // Fallback to localStorage
  const raw = localStorage.getItem(PKEY);
  return raw ? JSON.parse(raw) : [];
}

// Save records to both Supabase and localStorage
async function saveRecords(r, options = {}){ 
  const { promptForLogin = true } = options;

  // Check authentication first
  if (!currentUser) {
    if (promptForLogin) {
      showLoginModal();
    }
    return;
  }
  
  // Save to localStorage first (immediate)
  localStorage.setItem(PKEY, JSON.stringify(r));
  
  // Try to sync to Supabase
  if (!supabaseClient) {
    addLog('Supabase client not initialized', 'warn');
    return;
  }
  
  try {
    // Transform records to match Supabase schema
    const recordsToInsert = r.map(record => {
      const transformed = {
        batch: record.batch || null,
        population: record.population || 0,
        died: record.died || 0,
        age: record.age || null,
        weight: record.weight || 0,
        feed: record.feed || 0,
        sold: record.sold || null,
        mortality: record.mortality || 0,
        fcr: record.fcr === '—' ? null : (record.fcr || null),
        created_at: record.created || record.created_at || new Date().toISOString()
      };
      // Remove id if it exists (Supabase will auto-generate)
      delete transformed.id;
      return transformed;
    });
    
    // Delete all existing records first
    const { error: deleteError } = await supabaseClient
      .from(PROD_TABLE)
      .delete()
      .neq('id', 0); // Delete all
    
    if (deleteError) {
      console.error('Supabase delete error:', deleteError);
      throw new Error('Delete failed: ' + deleteError.message);
    }
    
    // Insert all records
    if (recordsToInsert.length > 0) {
      const { data, error: insertError } = await supabaseClient
        .from(PROD_TABLE)
        .insert(recordsToInsert)
        .select();
      
      if (insertError) {
        console.error('Supabase insert error:', insertError);
        throw new Error('Insert failed: ' + insertError.message);
      }
      
      addLog(`Production data synced to Supabase (${recordsToInsert.length} records)`, '');
      console.log('Supabase sync successful:', data);
    } else {
      addLog('Production data cleared from Supabase', '');
    }
  } catch (err) {
    console.error('Supabase sync failed:', err);
    addLog('Production data: Saved locally (Supabase sync failed: ' + err.message + ')', 'warn');
  }
}
async function renderHistory(){ 
  const body = el('historyBody'); 
  if(!body) return; 
  const records = await loadRecords({ promptForLogin: false }); 
  body.innerHTML=''; 
  records.slice().reverse().forEach((r, idx)=>{ 
    const tr = document.createElement('tr'); 
    tr.innerHTML = `<td>${r.batch||'—'}</td><td>${r.population||0}</td><td>${r.died||0}</td><td>${((r.mortality||0)*100).toFixed(2)}%</td><td>${r.age||'—'}</td><td>${r.weight||0}</td><td>${r.feed||0}</td><td>${r.fcr||'—'}</td><td>${r.sold||'—'}</td><td><button data-id='${records.length-1-idx}' class='edit'>Edit</button> <button data-id='${records.length-1-idx}' class='del'>Delete</button></td>`; 
    body.appendChild(tr); 
  }); 
  await renderSummary();
  body.querySelectorAll('.edit').forEach(b=>b.onclick=e=>{ const id=Number(e.target.dataset.id); editRecord(id); });
  body.querySelectorAll('.del').forEach(b=>b.onclick=e=>{ const id=Number(e.target.dataset.id); deleteRecord(id); });
}

async function renderSummary(){ 
  const records = await loadRecords({ promptForLogin: false }); 
  if(records.length===0){ 
    setText('v-concurrent','0'); 
    setText('v-batchno','—'); 
    setText('v-pop','0 birds'); 
    setText('v-died','0 birds'); 
    setText('v-mort','0%'); 
    setText('v-age','— days'); 
    setText('v-weight','0 g'); 
    setText('v-feed','0 g'); 
    setText('v-fcr','—'); 
    setText('v-sold','—'); 
    setText('kp-birds-alive','0'); 
    setText('kp-birds-dead','0'); 
    setText('kp-fcr','—'); 
    setText('kp-birds-sold','—'); 
    return;
  } 
  const latest=records[records.length-1]; 
  setText('v-concurrent', records.length); 
  setText('v-batchno', latest.batch||'—'); 
  setText('v-pop', (latest.population||0)+' birds'); 
  setText('v-died', (latest.died||0)+' birds'); 
  setText('v-mort', ((latest.mortality||0)*100).toFixed(2)+'%'); 
  setText('v-age', (latest.age||'—')+' days'); 
  setText('v-weight', (latest.weight||0)+' g'); 
  setText('v-feed', (latest.feed||0)+' g'); 
  setText('v-fcr', latest.fcr||'—'); 
  setText('v-sold', latest.sold||'—'); 
  setText('kp-birds-alive', ((latest.population||0)-(latest.died||0)-(Number(latest.sold)||0))||0); 
  setText('kp-birds-dead', latest.died||0); 
  setText('kp-fcr', latest.fcr||'—'); 
  setText('kp-birds-sold', latest.sold||'—'); 
}

async function addRecord(rec){ 
  const r = await loadRecords(); 
  r.push(rec); 
  await saveRecords(r); 
  await renderHistory(); 
}
async function editRecord(id){ 
  const records = await loadRecords(); 
  const rec=records[id]; 
  if(!rec) {
    await customAlert('Record not found');
    return;
  }
  
  const batch = await customPrompt('Batch no', rec.batch);
  if(batch===null) return;
  rec.batch=batch;
  
  const population = await customPrompt('Population', rec.population);
  if(population!==null) rec.population=Number(population)||rec.population;
  
  const died = await customPrompt('Died', rec.died);
  if(died!==null) rec.died=Number(died)||rec.died;
  
  const age = await customPrompt('Age', rec.age);
  if(age!==null) rec.age=Number(age)||rec.age;
  
  const weight = await customPrompt('Avg weight (g)', rec.weight);
  if(weight!==null) rec.weight=Number(weight)||rec.weight;
  
  const feed = await customPrompt('Feed consumed per bird (g)', rec.feed);
  if(feed!==null) rec.feed=Number(feed)||rec.feed;
  
  const sold = await customPrompt('Sold', rec.sold);
  if(sold!==null) rec.sold=sold||rec.sold;
  
  rec.mortality=(rec.died/rec.population)||0;
  rec.fcr=rec.feed&&rec.weight?(rec.feed/rec.weight).toFixed(2):rec.fcr;
  await saveRecords(records); 
  await renderHistory(); 
}

async function deleteRecord(id){ 
  const confirmed = await customConfirm('Delete this record?');
  if(!confirmed) return;
  const r = await loadRecords(); 
  r.splice(id,1); 
  await saveRecords(r); 
  await renderHistory(); 
}

el('btn-add').addEventListener('click', async ()=>{ 
  const batch = await customPrompt('Batch no (e.g., 8)');
  if(!batch) return;
  
  const populationStr = await customPrompt('Population (birds)', '1974');
  const population = Number(populationStr)||0;
  
  const diedStr = await customPrompt('Died (birds)', '0');
  const died = Number(diedStr)||0;
  
  const ageStr = await customPrompt('Age (days)', '14');
  const age = Number(ageStr)||0;
  
  const weightStr = await customPrompt('Average weight (g)', '453');
  const weight = Number(weightStr)||0;
  
  const feedStr = await customPrompt('Feed consumed (g per bird)', '467');
  const feed = Number(feedStr)||0;
  
  const sold = await customPrompt('Sold', 'nil');
  const soldValue = sold||'nil';
  
  const mortality=population? (died/population):0;
  const fcr=(feed&&weight)? Number((feed/weight).toFixed(2)) : '—';
  await addRecord({batch,population,died,age,weight,feed,sold:soldValue,mortality,fcr,created:new Date().toISOString()});
  await customAlert('Record saved successfully');
});

el('btn-clear').addEventListener('click', async ()=>{ 
  const confirmed = await customConfirm('Clear all production records? This action cannot be undone.');
  if(confirmed){
    localStorage.removeItem(PKEY); 
    // Also clear from Supabase
    if (supabaseClient) {
      try {
        await supabaseClient.from(PROD_TABLE).delete().neq('id', 0);
        addLog('Production data cleared from Supabase', '');
      } catch (err) {
        console.warn('Supabase clear failed:', err);
      }
    }
    await renderHistory(); 
  }
});

el('btn-export').addEventListener('click', async ()=>{ 
  const rows = await loadRecords(); 
  let csv='Batch,Population,Died,Mortality,Age,Weight,Feed,FCR,Sold\\n'; 
  rows.forEach(r=>{ 
    csv += `${r.batch},${r.population},${r.died},${((r.mortality||0)*100).toFixed(2)}%,${r.age},${r.weight},${r.feed},${r.fcr},${r.sold}\\n`; 
  }); 
  const blob=new Blob([csv],{type:'text/csv'}); 
  const url=URL.createObjectURL(blob); 
  const a=document.createElement('a'); 
  a.href=url; 
  a.download='production_history.csv'; 
  document.body.appendChild(a); 
  a.click(); 
  document.body.removeChild(a); 
  URL.revokeObjectURL(url); 
});

// Initial load
renderHistory();

el('download-csv').addEventListener('click', ()=>{ const logs=document.querySelectorAll('#logs .row'); let csv='Time,Message\\n'; logs.forEach(row=>{ const ts=row.querySelector('.ts')?.textContent.replace(/[\\[\\]]/g,'')||''; const msg=row.textContent.replace(ts,'').replace('•','').trim().replace(/"/g,'""'); csv += `\"${ts}\",\"${msg}\"\\n`; }); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='event_logs.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); });

el('download-sensors-csv').addEventListener('click', ()=>{ const s=sim; let csv='Sensor,Value\\n'; const keys=['temp','humidity','airQuality','voc_nh3','voc_no2','voc_h2s','voc_co','pm25','pm10','light','noise']; keys.forEach(k=>{ const val = s[k]; csv += `${k},${val !== null && val !== undefined ? val : 'nil'}\\n`; }); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='sensor_data.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); });

const devList = el('device-list'); devList.innerHTML=''; ['Sensor-01','Sensor-02','Sensor-03','Gateway-A'].forEach(n=>{ const li=document.createElement('li'); li.innerHTML=`<span>${n}</span><span class='badge online'>online</span>`; devList.appendChild(li); });

el('clear-logs').addEventListener('click', async ()=>{ 
  const confirmed = await customConfirm('Clear all event logs?');
  if(confirmed) el('logs').innerHTML=''; 
});

updateSensorsDisplay(sim);
      const thi = computeTHIFromSensors(sim); setTHI(thi);
</script>
</body>
</html>

